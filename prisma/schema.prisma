// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User (Admin) - The Sniper Master
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Client - PME
model Client {
  id             String   @id @default(uuid())
  name           String
  email          String?  // New email field replacing whatsapp
  sector         String?
  certifications String?  // Keep simple string for now or upgrade later
  
  // Phase 2: Enrichment
  siret          String?
  annualRevenue  Int?     // En k€
  employeeCount  Int?
  references     String?  // Texte libre pour références majeures

  active         Boolean  @default(true)
  searchUrl      String?  // BOAMP search URL to auto-extract parameters
  lastSourcingDate DateTime? // Granular look-back for n8n sourcing
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // "Pro" Architecture: Relations instead of CSV strings
  keywords       ClientKeyword[]
  departments    ClientDepartment[]

  searchConfig   SearchConfig?
  sniperRules    SniperRules?
  opportunities  Opportunity[]
}

// Relation table for Keywords (simulating String[] on SQLite)
model ClientKeyword {
  id       String @id @default(uuid())
  word     String
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

// Relation table for Departments/Regions (simulating String[] on SQLite)
model ClientDepartment {
  id       String @id @default(uuid())
  code     String // e.g. "75", "92"
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

// SearchConfig - Parameters for API PISTE/BOAMP
// Deprecated CSV fields removed in favor of direct relations on Client
model SearchConfig {
  id          String   @id @default(uuid())
  // keywords/departments moved to Client relations
  marketType  String?   // e.g. "Services", "Travaux"
  minBudget   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clientId    String   @unique
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

// SniperRules - AI filtering criteria
model SniperRules {
  id                     String   @id @default(uuid())
  mustHaveCertifications String?   // Comma-separated string
  forbiddenKeywords      String?   // Comma-separated string
  minProfitability       Int?     // Percentage
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  clientId               String   @unique
  client                 Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

// Tender - Raw tenders from API
model Tender {
  id        String   @id @default(uuid())
  id_boamp  String   @unique // External ID
  title     String
  summary   String
  pdf_url   String?
  status    String   // e.g., EXTRACTED, PROCESSED
  deadline  DateTime? // Date limite de réception des offres
  raw_data  Json?     // Store full BOAMP API response for AI context
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  opportunities Opportunity[]
}

// Opportunity - Match between Client and Tender
model Opportunity {
  id          String            @id @default(uuid())
  ai_analysis String            // Generated summary/analysis
  match_score Int               // 0-100
  status      String            @default("PENDING") // Enum removed for SQLite
  dume_data   String?           // Future use (Stored as JSON string)
  decision_token String?        @unique
  
  // Phase 2: Response Copilot
  dceFiles    Json?             // Legacy: List of sorted files (name, url, category). Deprecated by File model? Keep for backward compat.
  dceUrl      String?           // Direct link to ZIP profile acheteur
  analysis_summary Json?        // Step 2: Fiche de Synthèse (Critères, Pièces, Contact)
  
  processedAt DateTime?         // Date when AI analysis was completed
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tenderId    String
  tender      Tender   @relation(fields: [tenderId], references: [id])
  
  // Relations for Concierge Workflow
  dceRequests DCERequest[]
  files       File[]

  @@unique([clientId, tenderId])
}

// Concierge Workflow: Tracks User requests for DCE
model DCERequest {
  id        String   @id @default(uuid())
  status    String   @default("PENDING") // PENDING, PROCESSING, READY, REJECTED
  
  userEmail String?  // Optional: email of the user who requested (or link to User model if auth exists)
  
  opportunityId String
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Robust File Management
model File {
  id        String   @id @default(uuid())
  name      String   // e.g. "CCTP.pdf"
  url       String   // Storage URL (S3/Blob/Local)
  category  String   // ADMIN, TECH, FINANCE, OTHER
  size      Int?     // bytes
  mimeType  String?  // application/pdf, etc.
  
  opportunityId String
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// System State - For Incremental Sourcing
model SystemState {
  id            String   @id @default("global_config")
  lastCheckDate DateTime @default(now())
}
